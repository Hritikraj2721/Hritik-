# Background Listener + Thinker

import tkinter as tk
import speech_recognition as sr

recognizer = sr.Recognizer()
mic = sr.Microphone()
stop_listening = None   # will hold the stop function

class JarvisGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Jarvis Continuous Listener")

        self.status_label = tk.Label(root, text="Status: Idle", fg="green", font=("Arial", 11, "bold"))
        self.status_label.pack(pady=5)

        self.text_label = tk.Label(root, text="Heard: ", font=("Arial", 11))
        self.text_label.pack(pady=5)

        btn_frame = tk.Frame(root)
        btn_frame.pack(pady=10)

        self.start_btn = tk.Button(btn_frame, text="Start Listening", command=self.start_listening)
        self.start_btn.grid(row=0, column=0, padx=5)

        self.stop_btn = tk.Button(btn_frame, text="Stop Listening", command=self.stop_listening, state="disabled")
        self.stop_btn.grid(row=0, column=1, padx=5)

    def start_listening(self):
        global stop_listening
        self.set_status("Listening...")
        self.start_btn.config(state="disabled")
        self.stop_btn.config(state="normal")

        # Calibrate once before background loop
        with mic as source:
            recognizer.adjust_for_ambient_noise(source, duration=0.5)

        # Start background listener; callback runs in a new thread
        stop_listening = recognizer.listen_in_background(mic, self.callback, phrase_time_limit=5)

    def stop_listening(self):
        global stop_listening
        if stop_listening is not None:
            stop_listening()   # stops background thread on next phrase end
            stop_listening = None
        self.set_status("Idle")
        self.start_btn.config(state="normal")
        self.stop_btn.config(state="disabled")

    def callback(self, recognizer, audio):
        """This runs in a background thread; do NOT touch Tkinter directly here."""
        try:
            text = recognizer.recognize_google(audio, language="en-US")
        except sr.UnknownValueError:
            text = "(could not understand)"
        except sr.RequestError as e:
            text = f"(API error: {e})"

        # Schedule GUI updates safely in main thread
        self.root.after(0, self.update_text, text)

    def update_text(self, text):
        self.text_label.config(text=f"Heard: {text}")
        self.set_status("Listening...")

    def set_status(self, text):
        self.status_label.config(text=f"Status: {text}")

if __name__ == "__main__":
    root = tk.Tk()
    app = JarvisGUI(root)
    root.mainloop()
