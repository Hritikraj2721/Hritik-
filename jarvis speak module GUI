import threading
import speech_recognition as sr
import pyttsx3
import tkinter as tk
from tkinter import scrolledtext

# ---------------- Core Jarvis engines ----------------
recognizer = sr.Recognizer()
engine = pyttsx3.init()

def speak(text: str, gui):
    """Jarvis speaks and updates GUI."""
    gui.set_jarvis_text(text)
    gui.set_status("Speaking...")
    engine.say(text)
    engine.runAndWait()
    gui.set_status("Idle")

def listen(gui) -> str | None:
    """Listen from microphone, update GUI, return text."""
    with sr.Microphone() as source:
        gui.set_status("Listening...")
        gui.set_user_text("")
        recognizer.adjust_for_ambient_noise(source, duration=0.5)
        audio = recognizer.listen(source)

    try:
        gui.set_status("Recognizing...")
        text = recognizer.recognize_google(audio, language="en-US")
        gui.set_user_text(text)
        gui.set_status("Idle")
        return text
    except sr.UnknownValueError:
        gui.set_status("Did not understand")
        return None
    except sr.RequestError as e:
        gui.set_status(f"API error: {e}")
        return None

# ---------------- Tkinter GUI class ----------------
class JarvisGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Jarvis Assistant")

        # Status label
        self.status_label = tk.Label(root, text="Status: Idle", fg="green", font=("Arial", 11, "bold"))
        self.status_label.pack(pady=5)

        # User text box
        tk.Label(root, text="You said:", font=("Arial", 10, "bold")).pack(anchor="w", padx=5)
        self.user_text = scrolledtext.ScrolledText(root, height=4, width=50, state="disabled")
        self.user_text.pack(padx=5, pady=5)

        # Jarvis text box
        tk.Label(root, text="Jarvis:", font=("Arial", 10, "bold")).pack(anchor="w", padx=5)
        self.jarvis_text = scrolledtext.ScrolledText(root, height=4, width=50, state="disabled")
        self.jarvis_text.pack(padx=5, pady=5)

        # Control buttons
        btn_frame = tk.Frame(root)
        btn_frame.pack(pady=10)

        self.listen_button = tk.Button(btn_frame, text="Listen", width=12, command=self.start_conversation_thread)
        self.listen_button.grid(row=0, column=0, padx=5)

        self.quit_button = tk.Button(btn_frame, text="Quit", width=12, command=root.destroy)
        self.quit_button.grid(row=0, column=1, padx=5)

        # Greet once when GUI loads
        self.root.after(500, lambda: speak("Hello sir, Jarvis online. Press the listen button to talk to me.", self))

    # ---- helper methods to update GUI safely ----
    def set_status(self, text: str):
        self.status_label.config(text=f"Status: {text}")
        self.status_label.update_idletasks()

    def set_user_text(self, text: str):
        self.user_text.config(state="normal")
        self.user_text.delete("1.0", tk.END)
        self.user_text.insert(tk.END, text)
        self.user_text.config(state="disabled")
        self.user_text.update_idletasks()

    def set_jarvis_text(self, text: str):
        self.jarvis_text.config(state="normal")
        self.jarvis_text.delete("1.0", tk.END)
        self.jarvis_text.insert(tk.END, text)
        self.jarvis_text.config(state="disabled")
        self.jarvis_text.update_idletasks()

    # ---- conversation logic in a background thread ----
    def start_conversation_thread(self):
        # Avoid blocking the GUI mainloop
        t = threading.Thread(target=self.conversation_once, daemon=True)
        t.start()

    def conversation_once(self):
        # One listen â†’ respond cycle
        command = listen(self)
        if not command:
            return

        cmd = command.lower()

        if "stop jarvis" in cmd or "goodbye" in cmd or "exit" in cmd:
            speak("Shutting down. Goodbye.", self)
            self.root.after(500, self.root.destroy)
        elif "your name" in cmd:
            speak("I am Jarvis, your personal assistant.", self)
        elif "hello" in cmd:
            speak("Hello. How are you today?", self)
        else:
            speak("You said " + command, self)

# ---------------- Run the app ----------------
if __name__ == "__main__":
    root = tk.Tk()
    gui = JarvisGUI(root)
    root.mainloop()
